FROM quay.io/pawsey/pytorch:2.2.0-rocm5.7.3

## Add System Dependencies
# NOTE: Needs libxrender1 ImportError: libXrender.so.1: cannot open shared object file: No such file or directory (from pdbeccdutils.core import ccd_reader) throws the error
RUN apt-get update \
    && DEBIAN_FRONTEND=noninteractive \
    && apt-get install --no-install-recommends -y \
        build-essential \
        git \
        wget \
        gcc \
        libxrender1 \
        libxtst6 \
        libxext6 \
        libxi6 \
        kalign \
        curl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get autoremove -y \
    && apt-get clean

# Install Go and Rust to build WandB from source
ENV GO_VERSION=1.23.1
RUN wget -P /tmp https://dl.google.com/go/go${GO_VERSION}.linux-amd64.tar.gz
RUN tar -C /usr/local -xzf /tmp/go${GO_VERSION}.linux-amd64.tar.gz
RUN rm /tmp/go${GO_VERSION}.linux-amd64.tar.gz

ENV GOPATH /go
RUN mkdir -p "$GOPATH/src" "$GOPATH/bin" && chmod -R 777 "$GOPATH"

RUN curl --proto "=https" --tlsv1.2 -sSf https://sh.rustup.rs | bash -s -- -y
ENV CARGO_PATH=/root/.cargo

## Set environment variables
ENV ROCM_MAJOR=5
ENV ROCM_MINOR=7
ENV ROCM_PATCH=3
ENV ROCM_RELEASE=$ROCM_MAJOR.$ROCM_MINOR.$ROCM_PATCH

ENV ROCM_PATH=/opt/rocm-$ROCM_RELEASE
ENV LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$ROCM_PATH/lib
ENV CONDA_PREFIX=/opt/miniforge3

ENV PATH=$ROCM_PATH/bin:$ROCM_PATH/llvm/bin:$GOPATH/bin:/usr/local/go/bin:$CARGO_PATH/bin:$PATH

# Create a `rocm_version.h` file to allow for the installation of DeepSpeed
RUN mkdir -p /usr/include
RUN echo "#ifndef ROCM_VERSION_H" > /usr/include/rocm_version.h && \
    echo "#define ROCM_VERSION_H" >> /usr/include/rocm_version.h && \
    echo "" >> /usr/include/rocm_version.h && \
    echo "#define ROCM_VERSION_MAJOR ${ROCM_MAJOR}" >> /usr/include/rocm_version.h && \
    echo "#define ROCM_VERSION_MINOR ${ROCM_MINOR}" >> /usr/include/rocm_version.h && \
    echo "" >> /usr/include/rocm_version.h && \
    echo "#endif // ROCM_VERSION_H" >> /usr/include/rocm_version.h

## Install some Python dependencies
RUN pip install pytest \
    requests \
    biopandas --no-cache-dir

WORKDIR /app/alphafold

RUN python3 -c "import torch; print(torch.__version__)" || echo "PyTorch is not installed. "

## Clone and install the package + requirements
ARG GIT_TAG=rocm
RUN git clone https://github.com/amorehead/alphafold3-pytorch-lightning-hydra . --branch ${GIT_TAG} \
    && pip install .

RUN python3 -c "import torch; print(torch.__version__)" || echo "PyTorch is not installed. "

RUN python3 -c "import wandb; print(wandb.__version__)" || echo "WandB is not installed. "

# Check kalign
RUN kalign -h

# Install MMseqs2
RUN wget https://mmseqs.com/latest/mmseqs-linux-avx2.tar.gz \
    && tar xvfz mmseqs-linux-avx2.tar.gz

ENV MMSEQS_PATH=/app/alphafold/mmseqs
ENV PATH=$MMSEQS_PATH/bin:$PATH

RUN pwd
RUN ls /app/alphafold/mmseqs/bin
RUN mmseqs -h
